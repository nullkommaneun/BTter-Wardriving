<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data: https://*.tile.openstreetmap.org; style-src 'self' https://unpkg.com 'unsafe-inline'; script-src 'self' https://unpkg.com 'unsafe-inline'; connect-src 'self' blob:;"/>
  <title>BLE Scan ‚Äì Fahrmodus</title>
  <meta name="app-version" content="1.5.2"/>
  <link rel="manifest" href="./manifest.json" />
  <link rel="stylesheet" href="./styles.css" />
  <link rel="stylesheet" href="
</head>
<body>
<div id="errorBanner" style="display:none;background:#7f1d1d;color:#fff;padding:.5rem 1rem;font-weight:600">Fehler ‚Äì Details in der Konsole</div>
  <header>
    <h1>BLE Scan <span class="badge" id="modeBadge">Normalmodus</span> <small class="muted">v1.5.2</small></h1>
    <span id="jsProbe" class="badge muted">JS l√§dt‚Ä¶</span>
    <script>
      try {
        document.getElementById('jsProbe').textContent = 'JS geladen';
        window.addEventListener('error', function(e){
          var el = document.getElementById('err'); 
          if(!el){ return; }
          el.textContent = 'Script-Fehler: ' + (e.message || e.error);
          el.classList.remove('hidden');
        });
      } catch(e) {}
    </script>
    <div id="status">Preflight ausstehend‚Ä¶</div>
    <div class="stats">
      <div><span id="uniqueCount">0</span><label>Einzigartige Ger√§te</label></div>
      <div><span id="packetCount">0</span><label>Pakete gesamt</label></div>
      <div><span id="ratePerMin">0</span><label>Rate/min</label></div>
      <div><span id="lastPkt">‚Äì</span><label>Letztes Paket</label></div>
    </div>
    <div id="driveTicker" class="ticker hidden">Fahrmodus aktiv <span id="dots">‚Ä¢</span> <span id="hb" class="muted" style="margin-left:.5rem"></span></div>
  </header>

  <section class="controls">
    <button id="btnPreflight">Preflight pr√ºfen</button>
    <button id="btnStart" title="Startet den BLE-Scan">Scan starten</button>
    <button id="btnStop" disabled>Scan stoppen</button>
    <button id="btnResync" title="Scan neu synchronisieren">Resync</button>
    <label><input type="checkbox" id="toggleSW" checked /> SW aktiv</label>
    <label class="switch">
      <input type="checkbox" id="toggleDrive" />
      <span>Fahrmodus (WakeLock)</span>
    </label>
    <label><input type="checkbox" id="toggleCluster" checked/> Cluster (5 s)</label>
    <label title="Pfadverlust-Exponent, typ. 1.6‚Äì2.2 outdoor, 2‚Äì3 indoor">n=<input id="pathLossN" type="number" step="0.1" min="1.0" max="4.0" value="2.0" style="width:5rem"/></label>
  </section>

  <section class="filters">
    <input id="fName" placeholder="Ger√§tename enth√§lt‚Ä¶" />
    <input id="fRssiMin" type="number" placeholder="RSSI min (dBm, Standard: -80)" />
    <input id="fRssiMax" type="number" placeholder="RSSI max (dBm)" />
    <input id="fFrom" type="datetime-local" />
    <input id="fTo" type="datetime-local" />
    <button id="btnApplyFilters">Filter anwenden</button>
    <button id="btnClearFilters">Filter l√∂schen</button>
  </section>

  <section id="preflightPanel" class="panel">
    <h2>Preflight-Check</h2>
    <div id="pfList"></div>
    <div class="hint">
      Hinweise: Chrome/Android, HTTPS, Standort-Freigabe, ‚ÄûIn der N√§he‚Äú-Berechtigung. 
      In Chrome <code>chrome://flags</code> ‚Üí <b>Experimental Web Platform features</b> aktivieren (f√ºr <code>requestLEScan</code>).
    </div>
  </section>

  
<section class="layout">
  <div class="panel">
    <h2>Ger√§te</h2>
    <div class="hint">Eindeutige Ger√§te aus dem aktuellen Datenbestand. Klick f√ºr Details & Export.</div>
    <div class="devlist-controls">
      <input id="devSearch" placeholder="Suche (Name/UUID)‚Ä¶" />
      <span class="muted" id="devCount">0 Ger√§te</span>
    </div>
    <ul id="devList" class="devlist"></ul>
  </div>
  <div class="panel">
    <h2>Analyse</h2>
    <div id="analysisEmpty" class="hint">Kein Ger√§t ausgew√§hlt. W√§hle links ein Ger√§t aus.</div>
    <div id="analysis" class="hidden">
      <div class="analysis-header">
        <div class="title"><span id="anaIcon">üì°</span> <span id="anaName">‚Äì</span></div>
        <div class="meta"><span id="anaCat">‚Äì</span> ‚Ä¢ <span id="anaVendor">‚Äì</span></div>
      </div>
      <div class="grid">
        <div><label>Pakete</label><div id="anaPackets">0</div></div>
        <div><label>Erste Sichtung</label><div id="anaFirst">‚Äì</div></div>
        <div><label>Letzte Sichtung</label><div id="anaLast">‚Äì</div></div>
        <div><label>RSSI √ò / Median</label><div id="anaRssiStats">‚Äì</div></div>
        <div><label>Dist √ò / Median</label><div id="anaDistStats">‚Äì</div></div>
      </div>
      <div class="sparkline-block">
        <canvas id="anaSpark" width="800" height="160"></canvas>
      </div>
      <div class="raw-block">
        <h3>Rohdaten</h3>
        <div id="anaRawKeys" class="muted"></div>
        <pre id="anaRaw" class="debugjson"></pre>
      </div>
      <div class="export">
        <button id="btnExportJSONOne">Export JSON (Ger√§t)</button>
        <button id="btnExportCSVOne">Export CSV (Ger√§t)</button>
        <button id="btnFilterOnly">Nur dieses Ger√§t filtern</button>
      </div>
    </div>
  </div>
</section>


  <section class="export">
    <button id="btnExportJSON">Export JSON (alle)</button>
    <button id="btnExportCSV">Export CSV (alle)</button>
    <button id="btnExportCSVFiltered">Export CSV (gefiltert)</button>
    <button id="btnExportCSVCluster">Export CSV (Cluster 5s)</button>
  </section>

  <footer>
    <small>Offline-f√§hig (PWA). BLE-Scan nur in unterst√ºtzten Browsern und im Vordergrund. WakeLock h√§lt das Display aktiv.</small>
  </footer>

  <script src="</script>
  <script type="module" src="./js/main.js?v=1.5.2"></script>
</body>
</html>
