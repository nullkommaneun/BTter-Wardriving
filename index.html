<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>BLE Scan – Fahrmodus</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="app-version" content="1.6.0-inline" />
  <!-- CSP erlaubt Inline-Script für diesen Diagnoseschritt -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 img-src 'self' data:;
                 style-src 'self' 'unsafe-inline';
                 script-src 'self' 'unsafe-inline';
                 connect-src 'self' blob:;">
  <link rel="manifest" href="./manifest.json" />
  <link rel="stylesheet" href="./styles.css" />
  <style>
    /* Minimaler Look, falls styles.css fehlt */
    :root { color-scheme: light dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    header { padding: 12px 16px; background:#0ea5e9; color:#002233; }
    h1 { margin:0 0 6px 0; font-size: 20px; display:flex; gap:.5rem; align-items:baseline; }
    .badge { background:#fff; color:#0b4b6b; border-radius:999px; padding:.1rem .5rem; font-size:12px; }
    .muted { opacity:.8; font-size: 12px; }
    #errorBanner { display:none; }
    .stats { display:flex; gap:18px; margin-top:8px; flex-wrap:wrap; }
    .stats div { display:flex; flex-direction:column; }
    .stats span { font-weight:700; font-size:18px; }
    .controls, .filters, .layout, .export, .panel { padding: 12px 16px; }
    .controls button, .export button { margin-right:8px; margin-bottom:8px; }
    .devlist { list-style:none; padding:0; margin:8px 0 0 0; }
    .devlist li { padding:8px 10px; border:1px solid #ddd; border-radius:8px; margin-bottom:6px; }
    .devlist .name { font-weight:600; }
    .devlist .meta { font-size:12px; opacity:.8; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(160px,1fr)); gap:10px; }
    .hint { font-size: 12px; opacity:.8; }
    .hidden { display:none; }
    pre.debugjson { background:#1111; padding:8px; border-radius:6px; overflow:auto; }
    .ticker { margin-top:6px; }
  </style>
</head>
<body>
  <div id="errorBanner" style="background:#7f1d1d;color:#fff;padding:.5rem 1rem;font-weight:600">
    Fehler – Details in der Konsole
  </div>

  <header>
    <h1>BLE Scan <span class="badge">Fahrmodus</span> <small class="muted">v1.6.0-inline</small></h1>
    <div><span id="jsProbe" class="badge muted">JS lädt…</span></div>
    <div id="preflightStatus" class="muted">Preflight ausstehend…</div>
    <div id="status" class="muted">Bereit</div>

    <div class="stats">
      <div><span id="cntUnique">0</span><label>Einzigartige Geräte</label></div>
      <div><span id="cntPackets">0</span><label>Pakete gesamt</label></div>
      <div><span id="heartbeat">–</span><label>Heartbeat</label></div>
    </div>

    <div id="driveTicker" class="ticker hidden">
      Fahrmodus aktiv <span id="dots">•</span>
      <span id="hb2" class="muted" style="margin-left:.5rem"></span>
    </div>
  </header>

  <section class="controls">
    <button id="btnPreflight">Preflight prüfen</button>
    <button id="btnStart" title="Startet den BLE-Scan">Scan starten</button>
    <button id="btnStop" title="Scan stoppen">Scan stoppen</button>
    <button id="btnResync" title="Scan neu initialisieren">Resync</button>
    <div class="hint" style="margin-top:8px">
      Chrome/Chromium auf Android, HTTPS, Standort- & „In der Nähe“-Berechtigung.
      Unter <code>chrome://flags</code> ggf. <b>Experimental Web Platform features</b> aktivieren.
    </div>
  </section>

  <section class="panel">
    <h2>Geräte (Top 50)</h2>
    <ul id="devList" class="devlist"></ul>
  </section>

  <!-- DIAG: Single-File-Scanner inline (ohne Importe) -->
  <script type="module">
    const el = {
      probe: document.getElementById('jsProbe'),
      pf: document.getElementById('preflightStatus'),
      status: document.getElementById('status'),
      btnPre: document.getElementById('btnPreflight'),
      btnStart: document.getElementById('btnStart'),
      btnStop: document.getElementById('btnStop'),
      btnResync: document.getElementById('btnResync'),
      cntU: document.getElementById('cntUnique'),
      cntP: document.getElementById('cntPackets'),
      heartbeat: document.getElementById('heartbeat'),
      devList: document.getElementById('devList'),
      errorBanner: document.getElementById('errorBanner')
    };
    if (el.probe) el.probe.textContent = 'JS-Modul geladen (Single-inline)';

    function showError(msg){
      console.error(msg);
      if(el.errorBanner){ el.errorBanner.style.display='block'; el.errorBanner.textContent='Fehler: '+msg; }
      if(el.status){ el.status.textContent='Fehler: '+msg; }
    }
    window.addEventListener('error', e=> showError(e.message||'Uncaught error'));
    window.addEventListener('unhandledrejection', e=> showError(e.reason?.message||'Promise rejected'));

    let scanning = false;
    let lastTs = 0;
    const records = [];
    const uniq = new Set();
    let heartbeatTimer = null;

    function setPF(msg){ if(el.pf) el.pf.textContent = msg; if(el.status) el.status.textContent = msg; }
    function setStatus(msg){ if(el.status) el.status.textContent = msg; }
    function nowISO(){ return new Date().toISOString(); }

    async function preflight(){
      const okBLE  = !!(navigator.bluetooth && navigator.bluetooth.requestLEScan);
      const okGeo  = !!navigator.geolocation;
      const okWake = !!(navigator.wakeLock && navigator.wakeLock.request);
      const msg = `Preflight: requestLEScan:${okBLE?'OK':'NEIN'} | Geolocation:${okGeo?'OK':'NEIN'} | WakeLock:${okWake?'OK':'NEIN'}`;
      setPF(msg);
      return okBLE;
    }

    function deviceKey(name, uuids){
      const n = (name||'∅').trim().toLowerCase();
      const u = (Array.isArray(uuids)&&uuids[0])? uuids[0] : '∅';
      return n+'|'+u;
    }
    function hexFromView(view){
      if(!view) return '';
      let s=''; const v=new Uint8Array(view.buffer||view);
      for(let i=0;i<v.length;i++){ s += v[i].toString(16).padStart(2,'0'); }
      return s;
    }
    function listRender(){
      if(!el.devList) return;
      el.devList.innerHTML = '';
      const counts = new Map();
      for(const r of records){
        const k = deviceKey(r.deviceName, r.serviceUUIDs);
        counts.set(k, (counts.get(k)||0)+1);
      }
      const items = Array.from(counts.entries()).sort((a,b)=>b[1]-a[1]).slice(0,50);
      for(const [k,c] of items){
        const li = document.createElement('li');
        li.innerHTML = `<div class="name">${k}</div><div class="meta">${c} Pakete</div>`;
        el.devList.appendChild(li);
      }
    }

    async function startScan(){
      const ok = await preflight();
      if(!ok) throw new Error('requestLEScan nicht verfügbar (Browser/Flags/Berechtigungen prüfen)');
      const scan = await navigator.bluetooth.requestLEScan({
        keepRepeatedDevices: true,
        acceptAllAdvertisements: true
      });
      scanning = true;
      setStatus('Scan läuft…');

      function onAdv(e){
        try{
          const name = e.device && e.device.name || '';
          const rssi = typeof e.rssi === 'number' ? e.rssi : null;
          const tx  = typeof e.txPower === 'number' ? e.txPower : null;
          const serviceUUIDs = Array.isArray(e.uuids) ? e.uuids.slice() : [];

          const m = {};
          if(e.manufacturerData && e.manufacturerData.forEach){
            e.manufacturerData.forEach((val, key)=>{ m[String(key)] = hexFromView(val); });
          }
          const s = {};
          if(e.serviceData && e.serviceData.forEach){
            e.serviceData.forEach((val, key)=>{ s[String(key)] = hexFromView(val); });
          }

          const rec = {
            timestamp: nowISO(),
            deviceName: name || null,
            serviceUUIDs,
            rssi: (Number.isInteger(rssi)? rssi : (rssi!==null? Math.round(rssi): null)),
            txPower: tx,
            manufacturerData: m,
            serviceData: s
          };
          records.push(rec);
          lastTs = Date.now();

          const k = deviceKey(rec.deviceName, rec.serviceUUIDs);
          uniq.add(k);
          if(el.cntU) el.cntU.textContent = String(uniq.size);
          if(el.cntP) el.cntP.textContent = String(records.length);
          listRender();
        }catch(err){
          console.error('Adv-Parse-Fehler', err);
        }
      }

      navigator.bluetooth.addEventListener('advertisementreceived', onAdv);

      // Heartbeat/Auto-Re-Subscribe
      if(heartbeatTimer) clearInterval(heartbeatTimer);
      heartbeatTimer = setInterval(()=>{
        const silent = Math.floor((Date.now()-lastTs)/1000);
        if(el.heartbeat) el.heartbeat.textContent = `letztes Paket vor ${silent}s`;
        if(scanning && silent > 20){
          try{ navigator.bluetooth.removeEventListener('advertisementreceived', onAdv); }catch(_){}
          try{ navigator.bluetooth.requestLEScan({ keepRepeatedDevices:true, acceptAllAdvertisements:true }); }catch(_){}
          lastTs = Date.now();
        }
      }, 1000);

      // Stop nur einmal binden
      el.btnStop?.addEventListener('click', async ()=>{
        try{
          scanning = false;
          try{ navigator.bluetooth.removeEventListener('advertisementreceived', onAdv); }catch(_){}
          try{ scan.stop && scan.stop(); }catch(_){}
          if(heartbeatTimer){ clearInterval(heartbeatTimer); heartbeatTimer=null; }
          setStatus('Scan gestoppt');
        }catch(e){ setStatus('Stop-Fehler: '+e.message); }
      }, { once:true });
    }

    document.getElementById('btnPreflight')?.addEventListener('click', preflight);
    document.getElementById('btnStart')?.addEventListener('click', async ()=>{
      try{ await startScan(); } catch(e){ setStatus('Start-Fehler: '+e.message); }
    });
    document.getElementById('btnResync')?.addEventListener('click', async ()=>{
      try{ await startScan(); } catch(e){ setStatus('Resync-Fehler: '+e.message); }
    });
    document.addEventListener('DOMContentLoaded', preflight);
  </script>
</body>
</html>
